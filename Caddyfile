# You can keep a shared snippet for the proxy headers
(common_cf_headers) {
	# Trust Cloudflare-provided client IP if youâ€™re truly behind CF
	header_up X-Real-IP {http.request.header.CF-Connecting-IP}
	header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
}

# API site
{$API_DOMAIN} {
	@ws {
		header Connection *Upgrade*
		header Upgrade websocket
	}
	
	# Handle WebSocket connections with proper header forwarding
	reverse_proxy @ws {$CONTROLLER_UPSTREAM} {
		import common_cf_headers
		header_up Connection {http.request.header.Connection}
		header_up Upgrade {http.request.header.Upgrade}
	}
	
	# Handle regular HTTP requests
	reverse_proxy {$CONTROLLER_UPSTREAM} {
		import common_cf_headers
	}
}

# App site
{$APP_DOMAIN} {
	@ws {
		header Connection *Upgrade*
		header Upgrade websocket
	}
	reverse_proxy {$PANEL_UPSTREAM} {
		import common_cf_headers
	}
}